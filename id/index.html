<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <title>Copoint â€“ ID + Selfie Capture Wizard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Basit stil -->
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #020817;
            color: #e5e7eb;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: stretch;
            justify-content: center;
        }

        .app-shell {
            display: flex;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
            box-sizing: border-box;
            gap: 24px;
        }

        .left-panel,
        .right-panel {
            background: radial-gradient(circle at top left, #1f2937 0, #020617 50%);
            border-radius: 24px;
            border: 1px solid rgba(148, 163, 184, 0.3);
            box-shadow:
                0 0 0 1px rgba(15, 23, 42, 0.7),
                0 18px 45px rgba(15, 23, 42, 0.9);
            padding: 20px;
            box-sizing: border-box;
        }

        .left-panel {
            flex: 2;
            display: flex;
            flex-direction: column;
            gap: 16px;
            position: relative;
            overflow: hidden;
        }

        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .header-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo-dot {
            width: 20px;
            height: 20px;
            border-radius: 999px;
            background: radial-gradient(circle at 30% 30%, #22c55e, #15803d);
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.25);
        }

        .brand-text {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .brand-text strong {
            letter-spacing: 0.08em;
            text-transform: uppercase;
            font-size: 11px;
            color: #9ca3af;
        }

        .brand-text span {
            font-size: 13px;
            color: #6b7280;
        }

        .step-indicator {
            font-size: 13px;
            color: #9ca3af;
        }

        .step-indicator strong {
            color: #e5e7eb;
        }

        .camera-shell {
            position: relative;
            flex: 1;
            border-radius: 18px;
            overflow: hidden;
            background: radial-gradient(circle at top, #111827 0, #020617 60%);
            border: 1px solid rgba(55, 65, 81, 0.8);
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #overlay {
            position: absolute;
            inset: 0;
            border-radius: 16px;
            pointer-events: none;
        }

        /* Ortada kimlik iÃ§in kÄ±lavuz Ã§erÃ§eve (Ã¶n/arka) */
        #frame-guide {
            position: absolute;
            left: 50%;
            top: 50%;
            width: 65%;
            height: 42%;
            transform: translate(-50%, -50%);
            border-radius: 14px;
            border: 2px dashed rgba(148, 163, 184, 0.6);
            box-shadow:
                0 0 0 1px rgba(15, 23, 42, 0.7),
                0 0 20px rgba(15, 23, 42, 0.7);
            background: radial-gradient(circle at 10% 0, rgba(56, 189, 248, 0.08), transparent 55%);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #frame-guide span {
            font-size: 12px;
            color: #9ca3af;
            background: rgba(15, 23, 42, 0.85);
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid rgba(55, 65, 81, 0.9);
        }

        /* Selfie iÃ§in dairesel kÄ±lavuz */
        #selfie-circle {
            position: absolute;
            left: 50%;
            top: 52%;
            width: 52%;
            max-width: 260px;
            aspect-ratio: 1 / 1;
            transform: translate(-50%, -50%);
            border-radius: 999px;
            border: 2px dashed rgba(148, 163, 184, 0.7);
            background: radial-gradient(circle at 30% 0, rgba(56, 189, 248, 0.12), transparent 55%);
            box-shadow:
                0 0 0 1px rgba(15, 23, 42, 0.9),
                0 0 26px rgba(15, 23, 42, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
        }

        #selfie-circle span {
            font-size: 12px;
            color: #9ca3af;
            background: rgba(15, 23, 42, 0.9);
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid rgba(55, 65, 81, 0.9);
        }

        /* Debug iÃ§in dikdÃ¶rtgen */
        #debug-rect {
            position: absolute;
            border: 2px solid rgba(34, 197, 94, 0.9);
            border-radius: 10px;
            box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.9);
            display: none;
            pointer-events: none;
        }

        .status-bar {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-top: 12px;
            font-size: 13px;
        }

        .status-primary {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #e5e7eb;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 999px;
            background: #22c55e;
            box-shadow: 0 0 0 6px rgba(34, 197, 94, 0.16);
        }

        .hint {
            color: #9ca3af;
            font-size: 12px;
        }

        .control-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 16px;
            gap: 12px;
        }

        .btn-row {
            display: flex;
            gap: 8px;
        }

        button {
            border-radius: 999px;
            border: none;
            padding: 7px 14px;
            font-size: 13px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        button.primary {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: #052e16;
            font-weight: 600;
            box-shadow:
                0 0 0 1px rgba(34, 197, 94, 0.3),
                0 12px 24px rgba(22, 163, 74, 0.5);
        }

        button.primary:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            box-shadow: none;
        }

        button.secondary {
            background: rgba(15, 23, 42, 0.95);
            color: #e5e7eb;
            border: 1px solid rgba(55, 65, 81, 0.8);
        }

        button.secondary:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .right-panel h2 {
            margin: 0;
            font-size: 15px;
            font-weight: 600;
            color: #e5e7eb;
        }

        .right-panel p {
            margin: 0;
            font-size: 12px;
            color: #9ca3af;
        }

        .preview-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .preview-card {
            background: radial-gradient(circle at top, #111827 0, #020617 70%);
            border-radius: 16px;
            border: 1px solid rgba(55, 65, 81, 0.8);
            padding: 10px;
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #9ca3af;
            margin-bottom: 6px;
        }

        .preview-badge {
            font-size: 10px;
            padding: 3px 7px;
            border-radius: 999px;
            border: 1px solid rgba(55, 65, 81, 0.9);
            background: rgba(15, 23, 42, 0.95);
        }

        .preview-inner {
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid rgba(31, 41, 55, 0.8);
            background: #020617;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .preview-inner img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #020617;
        }

        .preview-placeholder {
            font-size: 11px;
            color: #4b5563;
        }

        .privacy-box {
            margin-top: 6px;
            padding: 8px 10px;
            border-radius: 12px;
            border: 1px solid rgba(31, 41, 55, 0.8);
            background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.07), #020617 60%);
            font-size: 11px;
            color: #9ca3af;
        }

        .privacy-box strong {
            color: #e5e7eb;
        }

        .submit-row {
            margin-top: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .submit-row p {
            font-size: 11px;
            color: #6b7280;
        }

        /* Canvas'larÄ± gizli tutuyoruz (iÅŸleme iÃ§in) */
        #process-canvas,
        #capture-canvas {
            display: none;
        }

        @media (max-width: 900px) {
            .app-shell {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
<div class="app-shell">
    <div class="left-panel">
        <div class="header-row">
            <div class="brand">
                <div class="logo-dot"></div>
                <div class="brand-text">
                    <strong>COPOINT ID</strong>
                    <span>Auto capture wizard â€“ web demo</span>
                </div>
            </div>
            <div class="step-indicator" id="step-indicator">
                AdÄ±m 1 / 3 Â· <strong>Kimlik Ã¶n yÃ¼z</strong>
            </div>
        </div>

        <div class="camera-shell">
            <video id="video" autoplay muted playsinline></video>

            <div id="overlay">
                <div id="frame-guide">
                    <span>KimliÄŸi Ã§erÃ§eve iÃ§ine hizala</span>
                </div>
                <div id="selfie-circle">
                    <span>YÃ¼zÃ¼nÃ¼ dairenin iÃ§ine hizala</span>
                </div>
                <div id="debug-rect"></div>
            </div>
        </div>

        <div class="status-bar">
            <div class="status-primary">
                <div class="status-dot"></div>
                <div id="status">KamerayÄ± kimliÄŸin Ã¶n yÃ¼zÃ¼ne doÄŸrult, sistem otomatik yakalayacak.</div>
            </div>
            <div class="hint" id="hint">
                Kimlik parlama yapÄ±yorsa telefonu hafifÃ§e eÄŸ veya aydÄ±nlatmayÄ± azalt.
            </div>
        </div>

        <div class="control-row">
            <div class="btn-row">
                <button class="secondary" id="restart-btn" disabled>
                    âŸ² AdÄ±mÄ± sÄ±fÄ±rla
                </button>
                <button class="secondary" id="manual-btn">
                    â¬¤ Manuel yakala
                </button>
            </div>
            <div class="btn-row">
                <button class="secondary" id="next-step-btn" disabled>
                    Sonraki adÄ±m
                </button>
            </div>
        </div>

        <canvas id="process-canvas"></canvas>
        <canvas id="capture-canvas"></canvas>
    </div>

    <div class="right-panel">
        <div>
            <h2>Otomatik Yakalama Ã–zeti</h2>
            <p>Kimlik Ã¶n/arka ve selfie karelerini, bulanÄ±k ve eÄŸik kareleri eleyerek alÄ±r.</p>
        </div>

        <div class="preview-group">
            <div class="preview-card">
                <div class="preview-header">
                    <span>Kimlik â€“ Ã–n YÃ¼z</span>
                    <span class="preview-badge">AdÄ±m 1</span>
                </div>
                <div class="preview-inner">
                    <img id="preview-front" alt="Ã–n yÃ¼z Ã¶nizleme" />
                    <div class="preview-placeholder" id="preview-front-placeholder">
                        HenÃ¼z yakalanmadÄ±
                    </div>
                </div>
            </div>

            <div class="preview-card">
                <div class="preview-header">
                    <span>Kimlik â€“ Arka YÃ¼z</span>
                    <span class="preview-badge">AdÄ±m 2</span>
                </div>
                <div class="preview-inner">
                    <img id="preview-back" alt="Arka yÃ¼z Ã¶nizleme" />
                    <div class="preview-placeholder" id="preview-back-placeholder">
                        HenÃ¼z yakalanmadÄ±
                    </div>
                </div>
            </div>

            <div class="preview-card">
                <div class="preview-header">
                    <span>Selfie</span>
                    <span class="preview-badge">AdÄ±m 3</span>
                </div>
                <div class="preview-inner">
                    <img id="preview-selfie" alt="Selfie Ã¶nizleme" />
                    <div class="preview-placeholder" id="preview-selfie-placeholder">
                        HenÃ¼z yakalanmadÄ±
                    </div>
                </div>
            </div>
        </div>

        <div class="privacy-box">
            <strong>Gizlilik Notu</strong><br />
            Bu demo sadece tarayÄ±cÄ± tarafÄ±nda Ã§alÄ±ÅŸÄ±r. GÃ¶nderim butonuna basmadÄ±ÄŸÄ±nÄ±z sÃ¼rece
            gÃ¶rseller arka uca iletilmez. Production ortamÄ±nda verileriniz ÅŸifreli kanallardan,
            belirli bir sÃ¼re saklanÄ±p otomatik silinecek ÅŸekilde tasarlanÄ±r.
        </div>

        <div class="submit-row">
            <button class="primary" id="submit-btn" disabled>
                âœ“ Devam et (backend'e gÃ¶nder)
            </button>
            <p>
                Bu buton ÅŸu anda sadece konsola JSON payload yazdÄ±rÄ±r.
                GerÃ§ek entegrasyonda Copoint ID / Documents API'sine gÃ¶nderirsiniz.
            </p>
        </div>
    </div>
</div>

<!-- OpenCV.js -->
<script async src="https://docs.opencv.org/4.x/opencv.js" onload="onOpenCvReady()"></script>

<script>
    const video = document.getElementById("video");
    const statusEl = document.getElementById("status");
    const stepIndicator = document.getElementById("step-indicator");
    const hintEl = document.getElementById("hint");
    const frameGuide = document.getElementById("frame-guide");
    const selfieCircle = document.getElementById("selfie-circle");

    const processCanvas = document.getElementById("process-canvas");
    const processCtx = processCanvas.getContext("2d", { willReadFrequently: true });
    const captureCanvas = document.getElementById("capture-canvas");
    const captureCtx = captureCanvas.getContext("2d");

    const debugRect = document.getElementById("debug-rect");

    const restartBtn = document.getElementById("restart-btn");
    const manualBtn = document.getElementById("manual-btn");
    const nextStepBtn = document.getElementById("next-step-btn");
    const submitBtn = document.getElementById("submit-btn");

    const previewFront = document.getElementById("preview-front");
    const previewBack = document.getElementById("preview-back");
    const previewSelfie = document.getElementById("preview-selfie");

    const previewFrontPlaceholder = document.getElementById("preview-front-placeholder");
    const previewBackPlaceholder = document.getElementById("preview-back-placeholder");
    const previewSelfiePlaceholder = document.getElementById("preview-selfie-placeholder");

    let stream = null;
    let processing = false;
    let captured = false;

    const steps = ["id_front", "id_back", "selfie"];
    let currentStepIndex = 0;
    let frontImage = null;
    let backImage = null;
    let selfieImage = null;

    // Stabilite iÃ§in basit state (Ã¶n/arka)
    let stableFrames = 0;
    const REQUIRED_STABLE_FRAMES = 8;
    const BLUR_THRESHOLD = 80.0;
    const MIN_CARD_AREA_RATIO = 0.15;

    let lastRect = null;

    function updateUIForStep() {
        const step = steps[currentStepIndex];

        if (step === "id_front") {
            stepIndicator.textContent = "AdÄ±m 1 / 3 Â· Kimlik Ã¶n yÃ¼z";
            statusEl.textContent = "KamerayÄ± kimliÄŸin Ã¶n yÃ¼zÃ¼ne doÄŸrult, sistem otomatik yakalayacak.";
            hintEl.textContent = "Kimlik Ã§erÃ§evenin tamamÄ±nÄ± doldursun, yansÄ±mayÄ± azaltmak iÃ§in hafif eÄŸ.";
            frameGuide.style.display = "flex";
            selfieCircle.style.display = "none";
        } else if (step === "id_back") {
            stepIndicator.textContent = "AdÄ±m 2 / 3 Â· Kimlik arka yÃ¼z";
            statusEl.textContent = "Åžimdi kimliÄŸin arka yÃ¼zÃ¼nÃ¼ MRZ alanÄ± net gÃ¶rÃ¼necek ÅŸekilde hizala.";
            hintEl.textContent = "MRZ satÄ±rlarÄ± (alt kÄ±sÄ±m) net ve okunaklÄ± olmalÄ±; parlamayÄ± azalt.";
            frameGuide.style.display = "flex";
            selfieCircle.style.display = "none";
        } else if (step === "selfie") {
            stepIndicator.textContent = "AdÄ±m 3 / 3 Â· Selfie";
            statusEl.textContent = "Selfie iÃ§in yÃ¼zÃ¼nÃ¼ dairenin iÃ§ine hizala, sistem otomatik yakalayacak.";
            hintEl.textContent = "GÃ¶zlerin aÃ§Ä±k, yÃ¼zÃ¼n iyi aydÄ±nlatÄ±lmÄ±ÅŸ olsun. Kimlikteki kiÅŸiyle eÅŸleÅŸme yapÄ±lacak.";
            frameGuide.style.display = "none";
            selfieCircle.style.display = "flex";
        }

        restartBtn.disabled = true;
        nextStepBtn.disabled = true;
        captured = false;
        processing = false;
        stableFrames = 0;
        lastRect = null;
        hideDebugRect();
    }

    async function initCamera() {
        if (stream) {
            stream.getTracks().forEach(t => t.stop());
            stream = null;
        }

        const step = steps[currentStepIndex];
        const isSelfie = step === "selfie";

        const constraints = {
            audio: false,
            video: {
                facingMode: isSelfie ? "user" : "environment",
                width: { ideal: 1280 },
                height: { ideal: 720 }
            }
        };

        try {
            stream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = stream;

            await new Promise(res => video.onloadedmetadata = res);
            video.play();

            processCanvas.width = video.videoWidth;
            processCanvas.height = video.videoHeight;
            captureCanvas.width = video.videoWidth;
            captureCanvas.height = video.videoHeight;

            processing = true;
            startProcessingLoop();
        } catch (err) {
            console.error(err);
            statusEl.textContent = "Kameraya eriÅŸilemedi: " + err.message;
        }
    }

    function onOpenCvReady() {
        console.log("OpenCV yÃ¼klendi.");
        updateUIForStep();
        initCamera();
    }

    function startProcessingLoop() {
        if (!processing) return;
        requestAnimationFrame(processFrame);
    }

    function showDebugRect(rect) {
        debugRect.style.display = "block";
        debugRect.style.left = rect.x + "px";
        debugRect.style.top = rect.y + "px";
        debugRect.style.width = rect.width + "px";
        debugRect.style.height = rect.height + "px";
    }

    function hideDebugRect() {
        debugRect.style.display = "none";
    }

    function varianceOfLaplacian(mat) {
        let mean = 0.0;
        let sqSum = 0.0;
        const total = mat.rows * mat.cols;

        for (let r = 0; r < mat.rows; r++) {
            for (let c = 0; c < mat.cols; c++) {
                const v = mat.doubleAt(r, c);
                mean += v;
            }
        }
        mean /= total;

        for (let r = 0; r < mat.rows; r++) {
            for (let c = 0; c < mat.cols; c++) {
                const v = mat.doubleAt(r, c);
                const diff = v - mean;
                sqSum += diff * diff;
            }
        }

        return sqSum / total;
    }

    function detectCardRect(edgesMat) {
        const contours = new cv.MatVector();
        const hierarchy = new cv.Mat();
        cv.findContours(edgesMat, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

        let bestRect = null;
        let bestArea = 0;

        for (let i = 0; i < contours.size(); i++) {
            const contour = contours.get(i);
            const approx = new cv.Mat();
            cv.approxPolyDP(contour, approx, 20, true);

            if (approx.rows === 4) {
                const rect = cv.boundingRect(approx);
                const area = rect.width * rect.height;

                if (area > bestArea) {
                    bestArea = area;
                    bestRect = rect;
                }
            }

            contour.delete();
        }

        contours.delete();
        hierarchy.delete();

        return bestRect;
    }

    function rectsCloseEnough(r1, r2) {
        const dx = Math.abs(r1.x - r2.x);
        const dy = Math.abs(r1.y - r2.y);
        const dw = Math.abs(r1.width - r2.width);
        const dh = Math.abs(r1.height - r2.height);

        const thresholdX = r1.width * 0.05;
        const thresholdY = r1.height * 0.05;
        const thresholdW = r1.width * 0.1;
        const thresholdH = r1.height * 0.1;

        return dx < thresholdX && dy < thresholdY && dw < thresholdW && dh < thresholdH;
    }

    function processFrame() {
        if (!processing || !video.videoWidth || !video.videoHeight) return;

        const step = steps[currentStepIndex];
        processCtx.drawImage(video, 0, 0, processCanvas.width, processCanvas.height);
        const frame = processCtx.getImageData(0, 0, processCanvas.width, processCanvas.height);

        let src = cv.matFromImageData(frame);
        let gray = new cv.Mat();
        let blurred = new cv.Mat();
        let edges = new cv.Mat();

        cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);
        cv.GaussianBlur(gray, blurred, new cv.Size(5, 5), 0, 0, cv.BORDER_DEFAULT);
        cv.Canny(blurred, edges, 50, 150);

        let lap = new cv.Mat();
        cv.Laplacian(gray, lap, cv.CV_64F);

        const blurMeasure = varianceOfLaplacian(lap);

        if (blurMeasure < BLUR_THRESHOLD) {
            statusEl.textContent = "GÃ¶rsel bulanÄ±k (" + blurMeasure.toFixed(0) + "). Telefona hafif dokun, netleÅŸtikten sonra yakalayacaÄŸÄ±z.";
            stableFrames = 0;
            hideDebugRect();
        } else {
            const cardRect = detectCardRect(edges);
            if (cardRect) {
                const area = cardRect.width * cardRect.height;
                const frameArea = processCanvas.width * processCanvas.height;
                const areaRatio = area / frameArea;

                if (areaRatio < MIN_CARD_AREA_RATIO) {
                    statusEl.textContent = "Kimlik kameraya biraz daha yaklaÅŸtÄ±r.";
                    stableFrames = 0;
                    hideDebugRect();
                } else {
                    showDebugRect(cardRect);

                    if (!lastRect || !rectsCloseEnough(lastRect, cardRect)) {
                        lastRect = cardRect;
                        stableFrames = 0;
                        statusEl.textContent = "Ã‡erÃ§eve iyi gÃ¶rÃ¼nÃ¼yor, biraz sabit tut.";
                    } else {
                        stableFrames++;
                        statusEl.textContent = "Sabit tespit: " + stableFrames + " / " + REQUIRED_STABLE_FRAMES;

                        if (!captured && stableFrames >= REQUIRED_STABLE_FRAMES) {
                            captured = true;
                            processing = false;
                            statusEl.textContent = "Kare yakalandÄ±.";
                            restartBtn.disabled = false;
                            nextStepBtn.disabled = false;
                            captureCurrentFrame(step);
                        }
                    }
                }
            } else {
                statusEl.textContent = "KimliÄŸi kÄ±lavuz Ã§erÃ§eveye tam oturtmaya Ã§alÄ±ÅŸ.";
                stableFrames = 0;
                hideDebugRect();
            }
        }

        src.delete();
        gray.delete();
        blurred.delete();
        edges.delete();
        lap.delete();

        if (processing) {
            requestAnimationFrame(processFrame);
        }
    }

    function captureCurrentFrame(step) {
        captureCtx.drawImage(video, 0, 0, captureCanvas.width, captureCanvas.height);
        const dataUrl = captureCanvas.toDataURL("image/jpeg", 0.9);

        if (step === "id_front") {
            frontImage = dataUrl;
            previewFront.src = dataUrl;
            previewFrontPlaceholder.style.display = "none";
        } else if (step === "id_back") {
            backImage = dataUrl;
            previewBack.src = dataUrl;
            previewBackPlaceholder.style.display = "none";
        } else if (step === "selfie") {
            selfieImage = dataUrl;
            previewSelfie.src = dataUrl;
            previewSelfiePlaceholder.style.display = "none";
        }

        if (frontImage && backImage && selfieImage) {
            submitBtn.disabled = false;
        }
    }

    function resetCurrentStep() {
        captured = false;
        processing = false;
        stableFrames = 0;
        lastRect = null;
        hideDebugRect();
        manualBtn.disabled = false;
        restartBtn.disabled = true;
        nextStepBtn.disabled = true;
        statusEl.textContent = "Tekrar deniyorsun, kamerayÄ± hedefe doÄŸrult.";
        startProcessingLoop();
    }

    function manualCapture() {
        if (captured) return;
        const step = steps[currentStepIndex];
        captureCurrentFrame(step);
        captured = true;
        processing = false;
        restartBtn.disabled = false;
        nextStepBtn.disabled = false;
        statusEl.textContent = "Manuel kare yakalandÄ±.";
    }

    // ================= MRZ VALIDATION HELPERS ===================
    // TR kimlik (TD1) 3 satÄ±rlÄ± MRZ iÃ§in 2 aÅŸamalÄ± doÄŸrulama

    function mrzCharValue(c) {
        if (c >= '0' && c <= '9') return c.charCodeAt(0) - 48;   // 0â€“9
        if (c >= 'A' && c <= 'Z') return c.charCodeAt(0) - 55;   // A=10, B=11...
        if (c === '<') return 0;                                 // filler
        return 0;
    }

    function mrzComputeCheckDigit(field) {
        const weights = [7, 3, 1];
        let sum = 0;
        for (let i = 0; i < field.length; i++) {
            const v = mrzCharValue(field[i]);
            sum += v * weights[i % 3];
        }
        return String(sum % 10);
    }

    function basicMrzStructureCheck(lines) {
        if (!Array.isArray(lines) || lines.length < 3) {
            return { ok: false, stage: 1, reason: "3 satÄ±rlÄ± MRZ bekleniyor." };
        }

        const [l1, l2, l3] = lines.map(l => (l || "").trim());

        if (l1.length !== 30 || l2.length !== 30 || l3.length !== 30) {
            return { ok: false, stage: 1, reason: "MRZ satÄ±r uzunluklarÄ± geÃ§ersiz." };
        }

        const allowed = /^[A-Z0-9<]+$/;
        if (!allowed.test(l1) || !allowed.test(l2) || !allowed.test(l3)) {
            return { ok: false, stage: 1, reason: "MRZ'de izin verilmeyen karakterler var." };
        }

        return { ok: true, stage: 1 };
    }

    function validateMrzTd1(lines) {
        const struct = basicMrzStructureCheck(lines);
        if (!struct.ok) return struct;

        const [l1, l2, l3] = lines.map(l => l.trim());

        try {
            // DokÃ¼man no: l2[0..8], check digit: l2[9]
            const docNumber = l2.slice(0, 9);
            const docCd = l2[9];

            // DoÄŸum tarihi YYMMDD: l2[13..18], check digit: l2[19]
            const dob = l2.slice(13, 19);
            const dobCd = l2[19];

            // Son geÃ§erlilik tarihi YYMMDD: l2[21..26], check digit: l2[27]
            const exp = l2.slice(21, 27);
            const expCd = l2[27];

            const docCalc = mrzComputeCheckDigit(docNumber);
            if (docCalc !== docCd) {
                return { ok: false, stage: 2, reason: "DokÃ¼man numarasÄ± check digit hatalÄ±." };
            }

            const dobCalc = mrzComputeCheckDigit(dob);
            if (dobCalc !== dobCd) {
                return { ok: false, stage: 2, reason: "DoÄŸum tarihi check digit hatalÄ±." };
            }

            const expCalc = mrzComputeCheckDigit(exp);
            if (expCalc !== expCd) {
                return { ok: false, stage: 2, reason: "Son geÃ§erlilik tarihi check digit hatalÄ±." };
            }

            return { ok: true, stage: 2 };
        } catch (err) {
            return { ok: false, stage: 2, reason: "MRZ parse edilirken hata: " + err.message };
        }
    }

    // ðŸ”¥ AdÄ±m deÄŸiÅŸince kamerayÄ± da yeniden init ediyoruz + MRZ kontrolÃ¼ (id_back aÅŸamasÄ±nda)
    async function goToNextStep() {
        const step = steps[currentStepIndex];

        // Sadece arka yÃ¼z â†’ selfiye geÃ§erken MRZ doÄŸrulamasÄ± yap
        if (step === "id_back") {
            if (!backImage) {
                statusEl.textContent = "Ã–nce kimliÄŸin arka yÃ¼zÃ¼nÃ¼ Ã§ekmelisin.";
                return;
            }

            statusEl.textContent = "MRZ okunuyor (1/2)â€¦";

            let mrzLines = null;

            // Test iÃ§in global sabit belirlediysen onu kullan
            if (window.MRZ_TEST_LINES && Array.isArray(window.MRZ_TEST_LINES)) {
                mrzLines = window.MRZ_TEST_LINES;
            } else {
                try {
                    const res = await fetch("https://your-backend/copoint/mrz-ocr", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ imageBase64: backImage.split(",")[1] })
                    });
                    if (!res.ok) throw new Error("HTTP " + res.status);
                    const json = await res.json();
                    mrzLines = json.mrzLines;
                } catch (err) {
                    console.error(err);
                    statusEl.textContent = "MRZ okunamadÄ±. KimliÄŸi daha net Ã§ekip tekrar dene.";
                    return;
                }
            }

            statusEl.textContent = "MRZ doÄŸrulanÄ±yor (2/2)â€¦";
            const validation = validateMrzTd1(mrzLines);

            if (!validation.ok) {
                console.warn("MRZ validation failed:", validation);
                statusEl.textContent = "MRZ hatasÄ±: " + validation.reason + " LÃ¼tfen kimliÄŸi tekrar Ã§ek.";
                return;
            }

            statusEl.textContent = "MRZ baÅŸarÄ±yla doÄŸrulandÄ± âœ…";
        }

        if (currentStepIndex < steps.length - 1) {
            currentStepIndex++;
            captured = false;
            processing = false;
            stableFrames = 0;
            lastRect = null;
            hideDebugRect();
            updateUIForStep();
            initCamera();   // kamera burada Ã¶n/arka olarak yeniden seÃ§iliyor
        }
    }

    async function submitAll() {
        if (!frontImage || !backImage || !selfieImage) return;

        const payload = {
            id_front: frontImage.split(",")[1],
            id_back: backImage.split(",")[1],
            selfie: selfieImage.split(",")[1],
            source: "browser_auto_capture_wizard"
        };

        console.log("GÃ¶nderilecek payload (kÄ±saltÄ±lmÄ±ÅŸ):", {
            ...payload,
            id_front: payload.id_front.slice(0, 30) + "...",
            id_back: payload.id_back.slice(0, 30) + "...",
            selfie: payload.selfie.slice(0, 30) + "..."
        });

        statusEl.textContent = "SimÃ¼le gÃ¶nderim: Konsola JSON yazÄ±ldÄ±.";

        /*
        try {
            const res = await fetch("https://your-backend/copoint/upload", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            if (!res.ok) throw new Error("HTTP " + res.status);
            const json = await res.json();
            statusEl.textContent = "Upload baÅŸarÄ±lÄ±. Sunucu yanÄ±tÄ±: " + JSON.stringify(json);
        } catch (err) {
            console.error(err);
            statusEl.textContent = "Upload hatasÄ±: " + err.message;
        }
        */
        statusEl.textContent = "SimÃ¼le: payload konsola yazÄ±ldÄ± (backend baÄŸlanÄ±nca burasÄ± aktif edilecek).";
    }

    restartBtn.addEventListener("click", resetCurrentStep);
    manualBtn.addEventListener("click", manualCapture);
    nextStepBtn.addEventListener("click", goToNextStep);
    submitBtn.addEventListener("click", submitAll);
</script>
</body>
</html>
